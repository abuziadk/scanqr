<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مسح QR - شاشة كاملة</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: "Tajawal", sans-serif;
    background: #f3f6f4;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    overflow: hidden;
  }
  #reader {
    width: 100%;
    height: 100%;
  }
  #scanMessage {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
    font-size: 24px;
    color: #017c67;
    font-weight: bold;
    background: rgba(255,255,255,0.7);
    padding: 10px 0;
  }
</style>
</head>
<body>

<div id="reader"></div>
<div id="scanMessage">انتظر، جارٍ تشغيل الكاميرا...</div>
<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

<script>
const API_URL = "PASTE_YOUR_DEPLOYED_WEBAPP_URL_HERE"; // ضع رابط الـ Web App

let scanner = null;

function startScanner() {
  if(scanner) try { scanner.stop(); } catch(e){}

  scanner = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: { width: window.innerWidth, height: window.innerHeight } };

  scanner.start({ facingMode: "environment" }, config, onScan, console.error);
}

function onScan(decodedText, decodedResult) {
  scanner.pause(); // إيقاف مؤقت لتجنب مسح متكرر
  handleQR(decodedText);
}

function handleQR(text) {
  let data;
  try { data = JSON.parse(text); } catch(e){
    document.getElementById("scanMessage").textContent = "QR غير صالح";
    setTimeout(startScanner, 2000);
    return;
  }

  if(!data.ID) {
    document.getElementById("scanMessage").textContent = "QR ناقص";
    setTimeout(startScanner, 2000);
    return;
  }

  const form = new URLSearchParams();
  form.append("action", "attendance");
  form.append("ID", data.ID || "");
  form.append("name", data.NAME || "");
  form.append("grade", data.GRADE || "");
  form.append("class", data.CLASS || "");
  form.append("parentMobile", data.parentMobile || "");

  fetch(API_URL, { method: "POST", body: form })
    .then(res => res.text())
    .then(msg => {
      document.getElementById("scanMessage").textContent = msg;
      document.getElementById("successSound").play();
      setTimeout(startScanner, 1500); // إعادة تشغيل الكاميرا
    })
    .catch(err => {
      document.getElementById("scanMessage").textContent = "خطأ في الاتصال";
      console.error(err);
      setTimeout(startScanner, 2000);
    });
}

// طلب Fullscreen تلقائي عند التحميل
document.addEventListener("DOMContentLoaded", () => {
  startScanner();
  if(document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen().catch(()=>{});
  }
});
</script>

</body>
</html>
